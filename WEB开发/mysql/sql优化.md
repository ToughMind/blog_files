---
title: "sql优化"
date: 2020-01-17T11:51:28+08:00
description: ""
lastmod: 2018-07-10T00:00:00+08:00
draft: false
tags: ["mysql"]
categories: ["mysql"]

weight: 1
contentCopyright: MIT
mathjax: true
autoCollapseToc: true
---
### 1、执行计划

- 数据库根据sql语句和相关表的统计信息作出的一个查询方案。由查询优化器自动分析产生。
  - 如sql语句10W中查1条，会选择索引；若该表只有5000，则使用全表扫描。
  
### 2、统一sql写法

- 大小写、空格不同，就是两个sql，必须进行两次解析。

### 3、sql不要太复杂

- 考虑到复杂性、重用性（约简单的sql语句约容易被重用，参见2）

### 4、使用“临时表”暂存中间结果

- 可简化sql语句。
- 有临时表，后面查询就不会扫描主表，减少“共享锁”阻塞“更新锁”，减少阻塞

### 5、OLTP系统sql语句必须采用绑定变量
```
where time > '10'
where time > '11'
```
- 以上两句，查询优化器认为是不同sql语句，需要解析两次

```
where time > @chgTime
```
- @chgTime可传入任何值，大量类似查询可重用该执行计划。

### 6、绑定变量窥测

- 对于5，“倾斜字段”不适用
- 如表的民族列90%是“汉族”，则查询韩泽和其他族所使用的策略应该不一样（全表扫，索引）。如果绑定变量，则一样了。

### 7、只在必要时使用begin tran

- 事务套住的sql越小越好
- 有些情况可以使用触发器同步数据，不一定要使用begin tran

### 8、一些sql语句应加上nolock

- oracle不需要，其可做到读、写互不影响
- 查询结果要“插、删、改”，不可用nolock
- 查询表属于频繁页分裂的，慎用
- 可用临时表代替，保存“数据前影”

### 9、聚集索引没有建在表的顺序字段上，容易发生页分裂

### 10、加nolock查询经常页分裂的表，容易跳读或重复读

### 11、like模糊查询注意
- 若是like '%LIU%'，由于LIU前有%，必然走全表扫描

### 12、Sql Server表连接的三种方式
- Merge Join
- Nested Loop Join
- Hash Join 